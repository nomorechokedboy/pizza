name: Preview deploy
on:
        pull_request:
                branches:
                        - dev

jobs:
        deploy-preview:
                runs-on: ubuntu-latest

                steps:
                        - name: Checkout
                          uses: actions/checkout@v2

                        - name: Context
                          uses: okteto/context@latest
                          with:
                                  token: '${{ secrets.OKTETO_TOKEN }}'

                        - name: Deploy the preview environment
                          uses: okteto/deploy-preview@latest
                          env:
                                  GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
                          with:
                                  name: pr-${{ github.event.number }}-nomorechokedboy

                        - name: Sleep for 120 seconds
                          uses: jakejarvis/wait-action@v0.1.0
                          with:
                                  time: '120s'

                        - name: Verify deploy preview
                          uses: srt32/uptime@master
                          with:
                                  url-to-hit: 'https://api-pr-${{ github.event.number }}-nomorechokedboy.cloud.okteto.net/healthz'
                                  expected-statuses: '200'
